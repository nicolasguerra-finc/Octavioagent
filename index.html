<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chat Octavio</title>
<style>
  :root{
    --chat-width: 360px;
    --chat-height: 460px;
    --bubble-radius: 14px;
    --accent: #09c26c;
  }

  body {
    margin: 0;
    padding: 0;
    background: url('Bannerunifin.png') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    font-family: "Poppins", system-ui, Arial, sans-serif;
  }

  /* Toggle + tooltip */
  .chat-toggle-wrapper {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .chat-tooltip {
    background-color: #fff;
    color: #000;
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 13px;
    white-space: nowrap;
    margin-bottom: 6px;
    opacity: 0;
    transition: opacity 0.18s ease;
    pointer-events: none;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    font-weight: 600;
  }
  .chat-toggle-wrapper:hover .chat-tooltip { opacity: 1; }

  /* ‚úÖ BURBUJA M√ÅS GRANDE (√∫nico cambio) */
  .chat-toggle-btn {
    width: 78px;       /* antes 64px */
    height: 78px;      /* antes 64px */
    border-radius: 50%;
    background: url('octavio.png') no-repeat center center;
    background-size: cover;
    border: none;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  }

  /* Chat container */
  .chat-container {
    position: fixed;
    bottom: 100px;
    right: 24px;
    width: var(--chat-width);
    height: var(--chat-height);
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 1001;
    box-sizing: border-box;
    transform-origin: bottom right;
    opacity: 0;
    transform: scale(0.95);
    transition: opacity 0.25s ease, transform 0.25s ease;
    pointer-events: none;
  }
  .chat-container.open {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
  }

  .chat-header {
    background: var(--accent);
    color: white;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .chat-header-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chat-header img {
    height: 30px;
    width: 30px;
    border-radius: 50%;
    object-fit: cover;
  }
  .chat-close-btn {
    background: transparent;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
  }

  .chat-messages {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    background: #fafafa;
  }

  .message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: var(--bubble-radius);
    max-width: 80%;
    word-wrap: break-word;
    font-size: 13px;
    line-height: 1.3;
    box-shadow: 0 1px 0 rgba(0,0,0,0.02) inset;
  }
  .message.user {
    background: #d9efff;
    margin-left: auto;
    text-align: right;
  }
  .message.bot {
    background: #ffffff;
    text-align: left;
    border: 1px solid rgba(0,0,0,0.04);
  }

  .chat-input {
    display: flex;
    gap: 6px;
    border-top: 1px solid #eee;
    height: 52px;
    box-sizing: border-box;
    padding: 8px;
    align-items: center;
    background: #fff;
  }

  .chat-input input[type="text"] {
    flex: 1;
    border: 1px solid #e6e6e6;
    padding: 10px 12px;
    font-size: 14px;
    border-radius: 8px;
    outline: none;
  }

  .chat-input button.send {
    background: var(--accent);
    color: white;
    border: none;
    padding: 9px 12px;
    cursor: pointer;
    border-radius: 8px;
    font-weight: 600;
  }

  .file-label {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #0ea564;
    color: #fff;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    cursor: pointer;
  }

  @media (max-width: 480px) {
    .chat-container { right: 12px; left: 12px; width: calc(100% - 24px); bottom: 80px; height: 420px; }
    .chat-toggle-btn { width: 72px; height: 72px; }
  }
</style>
</head>
<body>

<!-- Toggle + tooltip -->
<div class="chat-toggle-wrapper">
  <div class="chat-tooltip">¬øEn qu√© puedo ayudarte?</div>
  <button class="chat-toggle-btn" id="toggleBtn" aria-label="Abrir chat"></button>
</div>

<!-- Chat box -->
<div class="chat-container" id="chatBox" aria-hidden="true">
  <div class="chat-header">
    <div class="chat-header-title">
      <img src="octavio.png" alt="Octavio" />
      <strong>Octavio</strong>
    </div>
    <button class="chat-close-btn" id="closeBtn" aria-label="Cerrar">‚úñ</button>
  </div>

  <div class="chat-messages" id="chatMessages" role="log" aria-live="polite"></div>

  <div class="chat-input">
    <input type="text" id="userInput" placeholder="Escribe tu mensaje..." autocomplete="off"/>
    <label class="file-label" for="fileInput">üìé</label>
    <input type="file" id="fileInput" style="display:none" />
    <button class="send" id="sendBtn">Enviar</button>
  </div>
</div>

<script>
const WEBHOOK_URL = "https://sabrinalanzae.app.n8n.cloud/webhook/3f053e67-9626-4e49-bc2f-3adf22fba197/chat";

const chatBox = document.getElementById('chatBox');
const toggleBtn = document.getElementById('toggleBtn');
const closeBtn = document.getElementById('closeBtn');
const chatMessages = document.getElementById('chatMessages');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');

function toggleChat(){
  chatBox.classList.toggle('open');
  chatBox.setAttribute('aria-hidden', !chatBox.classList.contains('open'));
  if (chatBox.classList.contains('open')) setTimeout(()=> userInput.focus(), 220);
}
toggleBtn.addEventListener('click', toggleChat);
closeBtn.addEventListener('click', toggleChat);

function addMessage(role, text){
  if(!text || text.trim() === '') return;
  const msg = document.createElement('div');
  msg.className = 'message ' + (role === 'user' ? 'user' : 'bot');
  msg.innerHTML = renderMarkdown(escapeHtml(text));
  chatMessages.appendChild(msg);
  msg.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

function escapeHtml(unsafe){
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function renderMarkdown(text){
  return text
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.*?)\*/g, "<em>$1</em>")
    .replace(/\n/g, "<br>");
}

function getSessionId(){
  const key = "chat_session_id";
  let id = sessionStorage.getItem(key);
  if (!id) {
    id = crypto.randomUUID();
    sessionStorage.setItem(key, id);
  }
  return id;
}

let pendingFile = null;
fileInput.addEventListener('change', function(e){
  if (e.target.files.length > 0){
    pendingFile = e.target.files[0];
    addMessage('user', `üìé ${pendingFile.name}`);
  }
});

function extractTextFromResponse(data){
  if (typeof data === 'object' && data !== null) {
    const keys = ['output','response','message','text','reply','result'];
    for (const k of keys) {
      if (k in data && typeof data[k] === 'string' && data[k].trim() !== '') {
        return data[k];
      }
    }
    let longest = '';
    for (const k in data) {
      if (typeof data[k] === 'string' && data[k].length > longest.length) longest = data[k];
    }
    if (longest) return longest;
    try { return JSON.stringify(data); } catch(e){ return ''; }
  }

  if (typeof data === 'string') {
    const t = data.trim();
    if ((t.startsWith('{') && t.endsWith('}')) || (t.startsWith('[') && t.endsWith(']'))) {
      try {
        const parsed = JSON.parse(t);
        return extractTextFromResponse(parsed);
      } catch(e){}
    }
    return t;
  }
  return '';
}

async function sendMessage(){
  const text = userInput.value.trim();
  if (!text && !pendingFile) return;

  if (text) addMessage('user', text);
  userInput.value = '';
  userInput.disabled = true;
  sendBtn.disabled = true;

  const form = new FormData();
  form.append('sessionId', getSessionId());
  form.append('text', text || '');
  if (pendingFile) form.append('file', pendingFile);

  try {
    const res = await fetch(WEBHOOK_URL, { method: 'POST', body: form });
    let payload;
    try { payload = await res.json(); }
    catch (e) {
      const txt = await res.text();
      try { payload = JSON.parse(txt); }
      catch (e2) { payload = txt; }
    }

    const reply = extractTextFromResponse(payload);
    if (reply && reply.trim() !== '') {
      displayBotReplyInChunks(reply);
    } else {
      addMessage('bot', 'Lo siento, no entend√≠ la respuesta del servidor.');
    }
  } catch (e) {
    addMessage('bot', 'Ocurri√≥ un error al conectar con el asistente.');
  } finally {
    pendingFile = null;
    fileInput.value = '';
    userInput.disabled = false;
    sendBtn.disabled = false;
    userInput.focus();
  }
}

sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keydown', function(e){
  if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
});

function displayBotReplyInChunks(fullReply){
  const paragraphs = fullReply.split(/\n{2,}|\r\n{2,}/).filter(p => p.trim() !== '');
  paragraphs.forEach((p, i) => {
    setTimeout(() => addMessage('bot', p.trim()), i * 300);
  });
}

document.addEventListener('DOMContentLoaded', () => {});
</script>

</body>
</html>



